# Как работает идентификация средств 

## Пополение

### Открытие модалки
1. Нажали на кнопку "Внести средства", если профиль не инвестор, то блокируется
2. Если включено автоинвестирование, то показываем сообщение
3. Модалка общая с возвратом средств

### Сама форма
1. Физики и ИП могу пополнять через СБП
2. Есть константа с пользователями для которых заблокировано пополнение СБП + есть столбец в таблице users isDisableSbp
3. Указывается сумма от 0 до 100_000_000_000

### СБП
1. Нажимаем оплатить через СБП, валидация от 10 до 998_499, если ок, то показываем сообщение для подтверждения
2. Вызов функции clickToAddMoneyButton => /api/balance/sbptink,
   в ответе id, ссылка и qr-code в формате base64
   - делаем запрос на https://securepay.tinkoff.ru/v2/Init/, получаем paymentId
   - запрос на https://securepay.tinkoff.ru/v2/GetQr для получения qr кода, url и id
   - проверка на isDisableSbp в таблице users
   - достаем ИНН из базы
   - сохраняем запрос в таблице sbp для истории

### Счет на оплату
1. Вызов функции clickToAddMoneyButton => /api/balance/invoice_payment,
   в ответе данные для платежного поручения и qr-code в формате base64
2. Показываем платежное поручение, его можно скачать по запросу /api/balance/invoice_payment
   - генерируем qr-code и pdf на бэке, отдаем файл или данные

## Идентификация
1. Крон, вызываем tinkoffGetBankStatement
2. Запрос на /bank-statement?accountNumber передаем till? и from?
3. В ответе получаем
   - x-request-id ?
   - accountNumber
   - operation, массив выписок, каждая выписка имеет:
     - operationId, UID операции
     - paymentPurpose, назначение операции
     - payerInn,
     - payerAccount
     - recipient
     - реквизиты recipientAccount, recipientCorrAccount, recipientBic, recipientBank
4. Идем по всем операциям (выпискам), индетифицируем платеж
   - часть операций по operationId сразу пропускаем
   - 

5. Если индентицифровали, то запускаем status_notification, если уже запускали, то ничего не делаем, иначе пишем в телегу
